<!DOCTYPE html>
<meta charset="utf-8">
<style>
/* Nav Style */

* {
	font-family: sans-serif;
}

ul {
    list-style-type: none;
    margin: 0;
    padding: 0;
    overflow: hidden;
    background-color: #333;
}

li {
    float: left;
}

li a {
    display: block;
    color: white;
    text-align: center;
    padding: 14px 16px;
    text-decoration: none;
}


/* Map Style */
.background {
  fill: #999;
  pointer-events: all;
}

#states .active {
  fill: #66d;
}

#counties .active {
	fill: #66d;
}

#state-borders {
  fill: none;
  stroke: #000;
  stroke-width: 1px;
  stroke-linejoin: round;
  stroke-linecap: round;
  pointer-events: none;
}

#county-borders {
  fill: none;
  stroke: #000;
  stroke-width: .5px;
  stroke-linejoin: round;
  stroke-linecap: round;
  pointer-events: none;
}

.key {
	width: 14;
	height: 14;
}

.info {
	font-size: 20px;
	fill: white;
	font-weight: bold;
	font-family: sans-serif;
}

.key {
	font-size: 12px;
	fill: white;
	font-weight: bold;
	font-family: sans-serif;
	text-anchor: end;
}

#modes {
	font-size: 18px;
	font-weight: bold;
	font-family: sans-serif;
}

</style>

	<nav>
  		<ul>
  			<li><a href="/index.html">Home</a></li>
  			<li><a href="shootings/GunDeathsMapAB.html">Shootings</a></li>
		</ul>
	</nav>

<div id="option">
	<label class="info">View by:</label>
	<select id="modes"
			onchange = "switchMode()">
    	<option value="0">Total Shootings - State</option>
    	<option value="1">Total Shootings - County</option>
    	<option value="2">By Gender - State</option>
    	<option value="3">By Gender - County</option>
	</select>
</div>

<body>

<script src="//d3js.org/d3.v3.min.js"></script>
<script src="//d3js.org/queue.v1.min.js"></script>
<script src="//d3js.org/topojson.v1.min.js"></script>

<script>

/* 
	Map Example Used: http://bl.ocks.org/mbostock/2206590

*/

// map 
var mapMode = 0; // 0 - stateTotal, 1 - countyTotal 
var modeSelect = document.getElementById('modes');

var width = 960,
    height = 500,
    centered;

var infoWidth = 960,
	infoHeight = 108;

var currTransform = null,
	currStrokeWid = null;

var projection = d3.geo.albersUsa()
    .scale(1070)
    .translate([width / 2, height / 2]);

var path = d3.geo.path()
    .projection(projection);

/*=============== read csv ==================*/

var myData = [];
var countPerState = new Array(79);
var countPerCounty = new Array(78371);

// init
for(i = 0; i < countPerState.length; i++)
{
	countPerState[i] = {count: 0, numM: 0, numF: 0};
}
for(i = 0; i < countPerCounty.length; i++)
{
	countPerCounty[i] = {count: 0, numM: 0, numF: 0};
}

var body;

var stateNames = [];
var countyNames = [];

// read shooting data CSV
d3.csv("DataWithCounties.csv") 
	.row(function(d) {
		var el = {
			victimID: Number(d.victimID),
			date: new Date(d.date),
			name: d.name,
			gender: Number(d.gender),
			age: Number(d.age),
			ageGroup: Number(d.ageGroup),
			city: d.city,
			state: d.state,
			lat: Number(d.lat),
			lng: Number(d.lng),
			url: d.url,
			countyID: d.countyID,
			stateID: d.stateID
		};
		myData.push(el);
	})
	.get(function(error, rows) {
      	console.log(rows);
      	// sort data by ID
      	myData.sort(function(a, b)
      	{
      		return a.ID - b.ID;
      	});
      	countCrimes();
	});

// read state names tsv
d3.tsv("us-state-names.tsv", function(error, data) {
  	if (error) throw error;
  	// Coerce the data to numbers.
  	data.forEach(function(d) {
    	var el = {
			id: d.id,
			code: d.code,
			name: d.name
		};
		stateNames[d.id] = el;
  	});
  });


// read county names tsv
d3.tsv("us-county-names.tsv", function(error, data) {
  	if (error) throw error;
  	// Coerce the data to numbers.
  	data.forEach(function(d) {
    	var el = {
			id: d.id,
			name: d.name
		};
		countyNames[d.id] = el;
  	});
  });


/*============ end read csv ================*/


/*============ Create Map ==================*/
// svg for map
var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);

svg.append("rect")
    .attr("class", "background")
    .attr("width", width)
    .attr("height", height)
    .on("click", clicked);


var g = null; // g for map

// map colors
var stateDomain = [75, 150, 250, 375, 550, 850];
var countyDomain = [1, 10, 20, 40, 100, 250];


var totalRange = ["#ffeda0","#fed976","#feb24c","#fd8d3c","#fc4e2a","#e31a1c","#b10026"];
var genderRange = ["#c51b8a", "#f768a1","#fa9fb5", "#dfcae6", "#74a9cf", "#2b8cbe", "#045a8d"];

/* TODO */
// info graphic at bottom
var infoSvg = d3.select("body")
	.append("svg")
	.style("shape-rendering", "crispEdges")
	.attr("width", infoWidth)
	.attr("height", infoHeight);

// black panel
infoSvg.append("rect")
	.style("fill", "black")
	.attr("width", infoWidth)
	.attr("height", infoHeight);

// left gray panel
infoSvg.append("rect")
	.style("fill", "darkslategray")
	.attr("width", 300)
	.attr("height", infoHeight-10)
	.attr("x", 5)
	.attr("y", 5);

// right gray panel
infoSvg.append("rect")
	.style("fill", "darkslategray")
	.attr("width", 626)
	.attr("height", infoHeight-10)
	.attr("x", 310)
	.attr("y", 5);

// color legend rectangles
var key0 = infoSvg.append("rect")
	.style("fill", totalRange[0])
	.attr("width", 14)
	.attr("height", 14)
	.attr("x", 941)
	.attr("y", 5);

var key1 = infoSvg.append("rect")
	.style("fill", totalRange[1])
	.attr("width", 14)
	.attr("height", 14)
	.attr("x", 941)
	.attr("y", 19);

var key2 = infoSvg.append("rect")
	.style("fill", totalRange[2])
	.attr("width", 14)
	.attr("height", 14)
	.attr("x", 941)
	.attr("y", 33);

var key3 = infoSvg.append("rect")
	.style("fill", totalRange[3])
	.attr("width", 14)
	.attr("height", 14)
	.attr("x", 941)
	.attr("y", 47);

var key4 = infoSvg.append("rect")
	.style("fill", totalRange[4])
	.attr("width", 14)
	.attr("height", 14)
	.attr("x", 941)
	.attr("y", 61);

var key5 = infoSvg.append("rect")
	.style("fill", totalRange[5])
	.attr("width", 14)
	.attr("height", 14)
	.attr("x", 941)
	.attr("y", 75);

var key6 = infoSvg.append("rect")
	.style("fill", totalRange[6])
	.attr("width", 14)
	.attr("height", 14)
	.attr("x", 941)
	.attr("y", 89);

// text for the legend
var keyText1 = infoSvg.append("text")
	.text("MIN")
	.attr("class", "key")
	.attr("x", 932)
	.attr("y", 18);

var keyText2 = infoSvg.append("text")
	.text("MAX")
	.attr("class", "key")
	.attr("x", 932)
	.attr("y", 100);

// text for state info
var stateText = infoSvg.append("text")
	.attr("class", "info")
	.attr("y", 44)
	.attr("x", 20);

var countyText = infoSvg.append("text")
	.attr("class", "info")
	.attr("y", 79)
	.attr("x", 20);

var dataText = infoSvg.append("text")
	.attr("class", "info")
	.attr("y", 34)
	.attr("x", 325);

var dataText2 = infoSvg.append("text")
	.style("fill", "lightcoral")
	.attr("class", "info")
	.attr("y", 59)
	.attr("x", 325);

var dataText3 = infoSvg.append("text")
	.style("fill", "deepskyblue")
	.attr("class", "info")
	.attr("y", 84)
	.attr("x", 325);

var infoText = infoSvg.append("text")
	.attr("class", "info")
	.attr("y", 59)
	.attr("x", 20);




function clicked(d) {
	// position, scale
  var x, y, k;

  if (d && centered !== d) {
    var centroid = path.centroid(d);
    x = centroid[0];
    y = centroid[1];
    centered = d;


    // display Data for selected County/State
  	if(mapMode === 0){ // total state mode

  		k = 2.5; // zoom constant

  		infoText.text("")
  		stateText.text("State: " + stateNames[d.id].name);
  		countyText.text("");
  		dataText.text("Shootings: " + countPerState[d.id].count);

  		if(countPerState[d.id].count === 0){
  			dataText2.text("");
  			dataText3.text("");
  		}
  		else{
  			dataText2.text("Female: " + Math.round(1000*(countPerState[d.id].numF / countPerState[d.id].count))/10 + "%");
  			dataText3.text("Male: " + Math.round(1000*(countPerState[d.id].numM / countPerState[d.id].count))/10 + "%");
  		}
  	}
  	else if(mapMode === 1){ // total county mode

  		k = 3.5; // zoom constant

  		infoText.text("")
  		stateText.text("State: " + stateNames[Math.floor(d.id/1000)].name);
  		countyText.text("County: " + countyNames[d.id].name);
  		dataText.text("Shootings: " + countPerCounty[d.id].count);

  		if(countPerCounty[d.id].count === 0){
  			dataText2.text("");
  			dataText3.text("");
  		}
  		else{
  			dataText2.text("Female: " + Math.round(1000*(countPerCounty[d.id].numF / countPerCounty[d.id].count))/10 + "%");
  			dataText3.text("Male: " + Math.round(1000*(countPerCounty[d.id].numM / countPerCounty[d.id].count))/10 + "%");
  		}
  	}
  	else if(mapMode === 2){ // gender state mode

  		k = 2.5; // zoom constant

  		infoText.text("")
  		stateText.text("State: " + stateNames[d.id].name);
  		countyText.text("");
  		dataText.text("Shootings: " + countPerState[d.id].count);

  		if(countPerState[d.id].count === 0){
  			dataText2.text("");
  			dataText3.text("");
  		}
  		else{
  			dataText2.text("Female: " + Math.round(1000*(countPerState[d.id].numF / countPerState[d.id].count))/10 + "%");
  			dataText3.text("Male: " + Math.round(1000*(countPerState[d.id].numM / countPerState[d.id].count))/10 + "%");
  		}
  	}
  	else if(mapMode === 3){ // gender county mode

  		k = 3.5; // zoom constant

  		infoText.text("")
  		stateText.text("State: " + stateNames[Math.floor(d.id/1000)].name);
  		countyText.text("County: " + countyNames[d.id].name);
  		dataText.text("Shootings: " + countPerCounty[d.id].count);

  		if(countPerCounty[d.id].count === 0){
  			dataText2.text("");
  			dataText3.text("");
  		}
  		else{
  			dataText2.text("Female: " + Math.round(1000*(countPerCounty[d.id].numF / countPerCounty[d.id].count))/10 + "%");
  			dataText3.text("Male: " + Math.round(1000*(countPerCounty[d.id].numM / countPerCounty[d.id].count))/10 + "%");
  		}
  	}

  } else {
    x = width / 2;
    y = height / 2;
    k = 1;
    centered = null;
 	
    // display prompt and clear Data
 	if(mapMode === 0 || mapMode === 2){
    	infoText.text("Click on a State");
	}
	else if(mapMode === 1 || mapMode === 3){
		infoText.text("Click on a County");
	}


	stateText.text("");
  	countyText.text("");
  	dataText.text("");
	dataText2.text("");
  	dataText3.text("");
  }

  g.selectAll("path")
      .classed("active", centered && function(d) { return d === centered; });

  currTransform = "translate(" + width / 2 + "," + height / 2 + ")scale(" + k + ")translate(" + -x + "," + -y + ")";
  currStrokeWid = 1 / k + "px";

  g.transition()
      .duration(((mapMode === 0 || mapMode === 2) ? 750 : 1050))
      .attr("transform", currTransform)
      .style("stroke-width", currStrokeWid);
}




/* Functions to parse data into different types */

function countCrimes(){
	for(var i = 0; i < myData.length; i++)
	{

		countPerCounty[myData[i].countyID].count++;
		countPerState[myData[i].stateID].count++;

		if(myData[i].gender == 0)
		{
			countPerCounty[myData[i].countyID].numM++;
			countPerState[myData[i].stateID].numM++;
		}
		else if(myData[i].gender == 1)
		{
			countPerCounty[myData[i].countyID].numF++;
			countPerState[myData[i].stateID].numF++;
		}		
	}

	// get max of counties
	for(var i = 0; i < countPerCounty.length; i++)
	{
		thisCounty = countPerCounty[i];

		if(thisCounty.count > countyMax)
			countyMax = thisCounty.count;

		if((thisCounty.numM/thisCounty.count) > countyMaxMale)
			countyMaxMale = (thisCounty.numM/thisCounty.count);

		if((thisCounty.numF/thisCounty.count) > countyMaxFemale)
			countyMaxFemale = (thisCounty.numF/thisCounty.count);
	}
	// get max of states
	for(var i = 0; i < countPerState.length; i++)
	{
		thisState = countPerState[i];

		if(thisState.count > stateMax)
			stateMax = thisState.count;

		if((thisState.numM/thisState.count) > stateMaxMale)
			stateMaxMale = (thisState.numM/thisState.count);

		if((thisState.numF/thisState.count) > stateMaxFemale)
			stateMaxFemale = (thisState.numF/thisState.count);
	}

	// set color domain after final counts are completed
	setColorDomain();
}

// if color domain is dependent on max value of data: 
function setColorDomain()
{
	cColor2.domain(countyDomain);
	sColor2.domain(stateDomain);
	
	// 0 to 1 - 0% to 100%
	cColorG.domain([0,1]);
	sColorG.domain([0,1]);

	// draw map after correct color domains are set
	drawMap(0);
}

var countyMax = 0;
var stateMax = 0;

var countyMaxMale = 0;
var countyMaxFemale = 0;

var stateMaxMale = 0;
var stateMaxFemale = 0;


var cColor2 = d3.scale.threshold()
			.domain([0,1000])
			.range(totalRange);

var sColor2 = d3.scale.threshold()
			.domain([75, 150, 300, 600])
			.range(totalRange);

var cColorG = d3.scale.quantize()
			.domain([0,1])
			.range(genderRange);

var sColorG = d3.scale.quantize()
			.domain([0,1])
			.range(genderRange);

function redoKey()
{
	var totalHeight = 98;
	var startY = 5;

	var pxPerShooting;
	var thisHeight;

	if(mapMode === 0 || mapMode === 1)
	{
		if(mapMode === 0){
			pxPerShooting = totalHeight / stateMax;

			thisHeight = (Math.floor(pxPerShooting * stateDomain[0]) < 5) ? 5 : Math.floor(pxPerShooting * stateDomain[0]);
			key0.attr("y", startY);
			key0.attr("height", thisHeight);
			startY += thisHeight;

			thisHeight = (Math.floor(pxPerShooting * (stateDomain[1] - stateDomain[0])) < 5) ? 5 : 
									Math.floor(pxPerShooting * (stateDomain[1] - stateDomain[0]));
			key1.attr("y", startY);
			key1.attr("height", thisHeight);
			startY += thisHeight;

			thisHeight = (Math.floor(pxPerShooting * (stateDomain[2] - stateDomain[1])) < 5) ? 5 : 
									Math.floor(pxPerShooting * (stateDomain[2] - stateDomain[1]));
			key2.attr("y", startY);
			key2.attr("height", thisHeight);
			startY += thisHeight;

			thisHeight = (Math.floor(pxPerShooting * (stateDomain[3] - stateDomain[2])) < 5) ? 5 : 
									Math.floor(pxPerShooting * (stateDomain[3] - stateDomain[2]));
			key3.attr("y", startY);
			key3.attr("height", thisHeight);
			startY += thisHeight;

			thisHeight = (Math.floor(pxPerShooting * (stateDomain[4] - stateDomain[3])) < 5) ? 5 : 
									Math.floor(pxPerShooting * (stateDomain[4] - stateDomain[3]));
			key4.attr("y", startY);
			key4.attr("height", thisHeight);
			startY += thisHeight;

			thisHeight = (Math.floor(pxPerShooting * (stateDomain[5] - stateDomain[4])) < 5) ? 5 : 
									Math.floor(pxPerShooting * (stateDomain[5] - stateDomain[4]));
			key5.attr("y", startY);
			key5.attr("height", thisHeight);
			startY += thisHeight;

			thisHeight = 103-startY;
			key6.attr("y", startY);
			key6.attr("height", thisHeight);
			startY += thisHeight;

			keyText1.text("0");
			keyText2.text(stateMax);
		}
		else if(mapMode === 1)
		{
			pxPerShooting = totalHeight / countyMax;

			thisHeight = (Math.floor(pxPerShooting * countyDomain[0]) < 5) ? 5 : Math.floor(pxPerShooting * countyDomain[0]);
			key0.attr("y", startY);
			key0.attr("height", thisHeight);
			startY += thisHeight;

			thisHeight = (Math.floor(pxPerShooting * (countyDomain[1] - countyDomain[0])) < 5) ? 5 : 
									Math.floor(pxPerShooting * (countyDomain[1] - countyDomain[0]));
			key1.attr("y", startY);
			key1.attr("height", thisHeight);
			startY += thisHeight;

			thisHeight = (Math.floor(pxPerShooting * (countyDomain[2] - countyDomain[1])) < 5) ? 5 : 
									Math.floor(pxPerShooting * (countyDomain[2] - countyDomain[1]));
			key2.attr("y", startY);
			key2.attr("height", thisHeight);
			startY += thisHeight;

			thisHeight = (Math.floor(pxPerShooting * (countyDomain[3] - countyDomain[2])) < 5) ? 5 : 
									Math.floor(pxPerShooting * (countyDomain[3] - countyDomain[2]));
			key3.attr("y", startY);
			key3.attr("height", thisHeight);
			startY += thisHeight;

			thisHeight = (Math.floor(pxPerShooting * (countyDomain[4] - countyDomain[3])) < 5) ? 5 : 
									Math.floor(pxPerShooting * (countyDomain[4] - countyDomain[3]));
			key4.attr("y", startY);
			key4.attr("height", thisHeight);
			startY += thisHeight;

			thisHeight = (Math.floor(pxPerShooting * (countyDomain[5] - countyDomain[4])) < 5) ? 5 : 
									Math.floor(pxPerShooting * (countyDomain[5] - countyDomain[4]));
			key5.attr("y", startY);
			key5.attr("height", thisHeight);
			startY += thisHeight;

			thisHeight = 103-startY;
			key6.attr("y", startY);
			key6.attr("height", thisHeight);
			startY += thisHeight;


			keyText1.text("0");
			keyText2.text(countyMax);
		}

		key0.style("fill", totalRange[0]);
		key1.style("fill", totalRange[1]);
		key2.style("fill", totalRange[2]);
		key3.style("fill", totalRange[3]);
		key4.style("fill", totalRange[4]);
		key5.style("fill", totalRange[5]);
		key6.style("fill", totalRange[6]);
	}
	else if(mapMode === 2 || mapMode === 3)
	{
		key0.attr("height", 14);
		key1.attr("height", 14);
		key2.attr("height", 14);
		key3.attr("height", 14);
		key4.attr("height", 14);
		key5.attr("height", 14);
		key6.attr("height", 14);

		key0.attr("y", 5);
		key1.attr("y", 19);
		key2.attr("y", 33);
		key3.attr("y", 47);
		key4.attr("y", 61);
		key5.attr("y", 75);
		key6.attr("y", 89);

		key0.style("fill", genderRange[0]);
		key1.style("fill", genderRange[1]);
		key2.style("fill", genderRange[2]);
		key3.style("fill", genderRange[3]);
		key4.style("fill", genderRange[4]);
		key5.style("fill", genderRange[5]);
		key6.style("fill", genderRange[6]);

		keyText1.text("100% F");
		keyText2.text("100% M");
	}
	
}

function displayData()
{
	body = d3.select("body").selectAll("p")
		.data(myData)
  	  .enter()
  		.append("p")
  		.text(function(d) {
  			return d.ID + ": " + d.name + " (" + d.state + " - " + d.city + ")";
  		});
}

function switchMode()
{
	mapMode = modeSelect.selectedIndex;

	drawMap(mapMode);
}

function drawMap(mode) {
	if(g != null) {
		g.remove();
	}
	g = svg.append("g");
	
	if(mode === 0){ // state total

		d3.json("us.json", function(error, us) {
	  		if (error) throw error;

	  		g.append("g")
	      		.attr("id", "states")
	    	  .selectAll("path")
	      		.data(topojson.feature(us, us.objects.states).features)
	    	  .enter().append("path")
	      		.attr("d", path)
	      		.style("fill", function(d) { return countPerState[d.id].count == 0 ? "#ffffff" : 
	      			sColor2(countPerState[d.id].count);})
	      		.on("click", clicked);

	  		g.append("path")
	      		.datum(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; }))
	      		.attr("id", "state-borders")
	      		.attr("d", path);
			});

		if(centered == null)
		{
			infoText.text("Click on a State");
		}

	}
	else if(mode === 1){ // county total

		d3.json("us.json", function(error, us) {
	  		if (error) throw error;

	  		g.append("g")
	      		.attr("id", "counties")
	    	  .selectAll("path")
	      		.data(topojson.feature(us, us.objects.counties).features)
	    	  .enter().append("path")
	      		.attr("d", path)
	      		.style("fill", function(d) { return countPerCounty[d.id].count == 0 ? "#ffffff" : 
	      			sColor2(countPerCounty[d.id].count);})
	      		.on("click", clicked);

	  		g.append("path")
	      		.datum(topojson.mesh(us, us.objects.counties, function(a, b) { return a !== b; }))
	      		.attr("id", "county-borders")
	      		.attr("d", path);
			});

		if(centered == null)
		{
			infoText.text("Click on a County");
		}
		
	}
	else if(mode === 2){ // state gender

		d3.json("us.json", function(error, us) {
	  		if (error) throw error;

	  		g.append("g")
	      		.attr("id", "counties")
	    	  .selectAll("path")
	      		.data(topojson.feature(us, us.objects.states).features)
	    	  .enter().append("path")
	      		.attr("d", path)
	      		.style("fill", function(d) { return (countPerState[d.id].count !== 0) ? 
	      											sColorG(countPerState[d.id].numM/countPerState[d.id].count) : 
	      											"#ffffff"; })
	      		.on("click", clicked);

	  		g.append("path")
	      		.datum(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; }))
	      		.attr("id", "county-borders")
	      		.attr("d", path);
			});

		if(centered == null)
		{
			infoText.text("Click on a State");
		}

	}
	else if(mode === 3){ // county gender

		d3.json("us.json", function(error, us) {
	  		if (error) throw error;

	  		g.append("g")
	      		.attr("id", "counties")
	    	  .selectAll("path")
	      		.data(topojson.feature(us, us.objects.counties).features)
	    	  .enter().append("path")
	      		.attr("d", path)
	      		.style("fill", function(d) { return (countPerCounty[d.id].count !== 0) ? 
	      											sColorG(countPerCounty[d.id].numM/countPerCounty[d.id].count) : 
	      											"#ffffff"; })
	      		.on("click", clicked);

	  		g.append("path")
	      		.datum(topojson.mesh(us, us.objects.counties, function(a, b) { return a !== b; }))
	      		.attr("id", "county-borders")
	      		.attr("d", path);
			});

		if(centered == null)
		{
			infoText.text("Click on a County");
		}

	}
	
	redoKey();

	g.attr("transform", currTransform)
      .style("stroke-width", currStrokeWid);
}

</script>