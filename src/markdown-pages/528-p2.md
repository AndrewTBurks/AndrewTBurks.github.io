---
path: "/blog/vr-final-project"
date: "2020-04-25"
title: "Mixed-Platform Visual Data Science using VisSnippets"
featuredImage: ../images/528p2/sketch.jpg
---

_Made With_ <a href="https://unity.com/"><i class="fab fa-unity"></i></a> + <a href="https://nodejs.org/"><i class="fab fa-node-js"></i></a> + <a href="https://reactjs.org/"><i class="fab fa-react"></i></a>

**_new video goes here_**

<!-- `youtube: https://youtu.be/NPOKBQc9Rlc` -->

### Glossary

1. [Overview](#overview)
2. [The Data + Analysis](#the-data--analysis)
3. [Using The Application](#using-the-application)
4. [Current Limitations](#current-limitations)
5. [Source & Installation](#source-and-installation)

## Overview

[Background](#background-vissnippets) | [New Platforms](#extending-the-analysis-to-new-platforms) | [Primary Concepts](#primary-concepts) | [Top <i class="fas fa-angle-double-up"></i>](#glossary)

![Idea Sketch](../images/528p2/sketch.jpg "An early sketch of the project design.")

### Background: VisSnippets

The VisSnippets project serves as the foundation for this Virtual Reality application. VisSnippets is a system for collaborative visual data exploration on Large Displays using the SAGE2 Middleware. VisSnippets allows users to write, in parallel, snippets of code which can be composed into branching data pipelines. Leveraging the screen real estate provided by SAGE2 on Large Displays, users can arrange their collaborative analysis across the two dimensional space.

Snippets are categorized into three primary types: Data Generation, Data Transformation, and Visualization. The types semantically separate the operation which occurs in the code. When a user chooses to compose a snippet onto an existing section of the data pipeline, the VisSnippets system creates a reactive data connection between the two blocks. Any changes to code (and data, as a result) in the pipeline will propagate to downstream branches of the analysis.

`youtube: https://www.youtube.com/watch?v=8fC6FwrD20g`

![Snippets Workspace](../images/528p2/SnippetsWorkspace.PNG "The VisSnippets Workspace. Left: The Snippet editor supports viewing and editing code from analysis blocks. Top Right: A List of Snippets and a Tree Visualization of the composed Data Flows. Bottom Right: A display of the data output from the selected analysis block 'COVID-19 API.'")

### Extending the Analysis to New Platforms

By refining the VisSnippets runtime, it is possible for it to run on multiple platforms including within the Web Browser or on a NodeJS server backend. By placing the analysis backend on a server, the server can also expose a REST API which allows multiple client types to interact with the runtime.

The new possibilities which are opened up by this improvement are the foundation of this project, using Unity3D as a view client which supports a VR application for viewing and interacting with the data analysis in a generalized manner that is data-agnostic.

### Primary Concepts

#### Expressive Data Exploration

This project utilizes the VisSnippets workflow and architecture as a foundation to support expressive data exploration and analysis. Rather than predefining a set of connections between analytical building blocks in a Unity application, the goal is to support a variety of analyses with a predefined set of _types_ of operations shared between the Unity application and the backend.

VisSnippets serves as the architecture which lends flexibility in analysis to a Unity application.

#### Careful Abstraction

The flexibility in data analysis and the opportunity to support a new Unity VR application as a client are supported by _Careful Abstraction_ in the VisSnippets architecture.

We implement and expose API calls under the name SAGE2 to the snippets which allow snippets to utilize powerful functionality within their code. This implementation can vary depending on the platform which the VisSnippets runtime is deployed on in order to maintain the intended functionality of the code.

The two methods in this scenario which are the most critical to this application are the following:

**SAGE2.VegaLiteChart**

This operation creates a Vega-Lite chart for VisSnippets, predefining the size and passing the data into the method explicitly. This also renders the chart as appropriate for platform. When run in the Browser, the Vega-Lite chart gets rendered to a Canvas element that is displayed on the screen. When run on the Server, the Vega-Lite chart is not rendered visibly, but is converted to a buffer and sent as an `image/png` response when the API endpoint specifying that image is requested.

```javascript
SAGE2.VegaLiteChart({
  // an array of objects
  data,
  // a partial Vega-Lite specification which defines the encodings
  spec,
});
```

**SAGE2.SnippetExternalOp**

This operation allows a snippet to specify a mapping from the source data to a generic form which can be ingested and used in another context. In this scenario, the other context is the Unity application. Its format is as follows:

```javascript
var selectedValue = SAGE2.SnippetExternalOp({
  // operation name within a predefined set (future: filter)
  operation: "select",
  // a title for display purposes only
  name: "Operation Name",
  // an array of objects
  inputData: data,
  // default to the first element in the array
  defaultValue: data[0],
  // the target data format (future: xy or latlng)
  dataFormat: "xyz",
  // numbers to be mapped to the x, y, and z dimensions
  fields: ["field_A", "field_B", "field_C"],
  // a string to display as the label for each data point
  labelField: "field_name",
});
```

This operation allows a snippet to specify a mapping from the source data to a generic form which can be ingested and used in another context. In this scenario, the other context is the Unity application. Its format is as follows:

#### Blended Front/Back-End Architecture

As mentioned in the previous section, the API implementations which are exposed to the snippets vary slightly in order to adapt to the platform. For use in a Server, these methods are adapted to best suit the structure of a RESTful API. To achieve this blended Front/Back-End architecture, the server exposes enough information for the Unity application to be able to display and interact with the structure of the analysis.

When launched, the Unity application requests the set of `nodes` from the Server. This response includes all of the analysis blocks along with their graph positions. Additionally, this provides information about the snippet used in that block and flags for `hasImage` and `externalOperation`.

The `hasImage` flag lets Unity know that there is an Image which can be retrieved dynamically if that node of the graph is selected. In this case, this is true when the `VegaLiteChart` method was used in a snippet. Similarly, the `externalOperation` flag is set as `true` when the `SnippetExternalOp` method was used in a snippet.

With these flags, the Unity application can retrieve the image or the external operation information with each's respective endpoint on the server.

## The Data + Analysis

![Analysis Pipeline (Editor)](../images/528p2/DataFlows.PNG "The specified Analysis Pipeline as seen in the VisSnippets Workspace.")
![Analysis Pipeline (Unity)](../images/528p2/DataFlowsUnity.PNG "The specified Analysis Pipeline as seen in the VR Application (mirrored vertically in relation to the Editor).")

**Walk through the analysis pipeline in prose**

## Using The Application

- load up unity, what do you see
- explain the data graph

-

## Current Limitations

- There are issues with external dependency management that need to be addressed in terms of differences between browser dependencies and server-side dependencies
- VisSnippets Workspace config needs to be exported and placed as the backend config

### Future Extensions

- Arrange images and the spatial views in the VR world
- Allow viewers to compose more operations onto the existing data pipeline

## Source and Installation

### VisSnippets Frontend + Backend

The source for the VisSnippets Frontend and Backend described are currently closed-source as of the creation of this post. If you would like to learn more, please reach out.

### Unity Application

#### [**GitHub** @AndrewTBurks/528P2_Burks <i class="fab fa-github"></i>](https://github.com/AndrewTBurks/528P2_Burks)

To _Install_ and _Run_ the application, clone the repository locally and add the project to UnityHub or open it in Unity using **Version 2019.2.11f**.

By default, the project should be configured to run on Desktop using the CAVE2 Simulator from the omicron-unity module. To configure to run for Vive, go to the Omicron menu and select **Configure for Vive**. Similarly, to run in CAVE2, return to the same menu and select **Configure for CAVE2** and follow the [rest of the build/run steps](https://github.com/uic-evl/omicron-unity/wiki/Guide-for-running-Unity-in-CAVE2#building-on-cave2).

All Assets and packages required are included in the repository, and the Library folder should rebuild when opened in Unity.

### Controls

## Analysis Details

<div class="content-warning">Warning: The table below should be viewed at a resolution with width >850px</div>

The table below outlines the specific set of operations put together to form the data pipeline seen in the application.

<table class="code-table">
<thead>
<th>Name</th>
<th>Code</th>
</thead>
<tbody>
<tr>
  <td>COVID-19 API 
    <div class="description">
      Fetch COVID-19 current cases by Country from <a href="https://covid19api.com/">covid19api.com</a>
    </div>
  </td>
  <td>

```javascript
var requestOptions = {
  method: "GET",
  redirect: "follow",
};
var url = "https://api.covid19api.com/summary";

fetch(url, requestOptions)
  .then(res => res.json())
  .then(next);
```

  </td>
</tr>

<tr>
  <td>BarChart Country
    <div class="description">
      Create a bar chart with VegaLite that shows the total deaths per country for countries with > 300
    </div>
  </td>
  <td>

```javascript
const date = {
  x: {
    field: "Date",
    type: "temporal",
  },
};

const yField = name => ({
  field: name,
  type: "quantitative",
  scale: {
    zero: "true",
  },
});

let spec = {
  title: "Deaths by Country",
  // below is the custom visualization specification
  transform: [
    {
      filter: "datum.TotalDeaths >= 300",
    },
  ],
  mark: {
    type: "bar",
    filled: true,
  },
  encoding: {
    // column: {}
    x: {
      field: "Country",
      type: "nominal",
      sort: "-y",
    },
    y: yField("TotalDeaths"),
  },
};

SAGE2.VegaLiteChart({
  data: data.Countries,
  spec,
});
```

  </td>
</tr>

<tr>
  <td>External Select Country
    <div class="description">
      Specify an External "select" operation using an XYZ encoding with the specified fields. Next, fetch time-series data for the selected country from <a href="https://covid19api.com/">covid19api.com</a>
    </div>
  </td>
  <td>

```javascript
var country = SAGE2.SnippetExternalOp({
  operation: "select",
  name: "Select Country",
  defaultValue: data.Countries[20], // some default value
  inputData: data.Countries,
  dataFormat: "xyz",
  fields: ["TotalConfirmed", "TotalDeaths", "NewDeaths"],
  labelField: "Country",
});

fetch("https://api.covid19api.com/country/" + country.Slug)
  .then(res => res.json())
  .then(next);
```

  </td>
</tr>

<tr>
  <td>Vega-Lite Line Chart
    <div class="description">
      Visualize the time-series data for a country using a Line Chart built with Vega-Lite
    </div>
  </td>
  <td>

```javascript
const date = {
  x: {
    field: "Date",
    type: "temporal",
  },
};

const yField = name => ({
  field: name,
  type: "quantitative",
  scale: {
    zero: "true",
  },
});

const layer = (name, color = "blue") => ({
  mark: {
    type: "line",
    filled: false,
  },
  encoding: {
    x: {
      field: "Date",
      type: "temporal",
    },
    y: yField(name),
    color: {
      value: color,
    },
  },
});

let spec = {
  title: data[0].Country,
  // below is the custom visualization specification
  layer: [
    layer("Confirmed"),
    layer("Deaths", "#db646f"),
    layer("Recovered", "green"),
  ],
};

SAGE2.VegaLiteChart({
  data,
  spec,
});
```

  </td>
</tr>

<tr>
  <td>US COVID-19
    <div class="description">
      Retrieve data per state from <a href="https://covidtracking.com">covidtracking.com<a>
    </div>
  </td>
  <td>

```javascript
fetch("https://covidtracking.com/api/states")
  .then(res => res.json())
  .then(next);
```

  </td>
</tr>

<tr>
  <td>Ext Select State
    <div class="description">
      Specify an External "select" operation using an XYZ encoding with the specified fields
    </div>
  </td>
  <td>

```javascript
var state = SAGE2.SnippetExternalOp({
  operation: "select",
  name: "Select State",
  defaultValue: data.find(s => s.state === "IL"),
  inputData: data,
  dataFormat: "xyz",
  fields: ["totalTestResults", "positive", "negative"],
  labelField: "state",
});

next(state);
```

  </td>
</tr>

<tr>
  <td>BarChart State
    <div class="description">
      A Bar Chart of case info (tests, negative, positive, deaths) for a single state
    </div>
  </td>
  <td>

```javascript
const chartData = [
  {
    type: "Total Tests",
    value: data.totalTestResults,
  },
  {
    type: "Negative",
    value: data.negative,
  },
  {
    type: "Positive",
    value: data.positive,
  },
  {
    type: "Deaths",
    value: data.death,
  },
];

let spec = {
  // below is the custom visualization specification
  title: "Cases in " + data.state,
  mark: {
    type: "bar",
    filled: true,
  },
  encoding: {
    // column: {}
    x: {
      field: "type",
      type: "nominal",
      sort: null,
    },
    y: {
      field: "value",
      type: "quantitative",
    },
  },
};

SAGE2.VegaLiteChart({
  data: chartData,
  spec,
});
```

  </td>
</tr>

<!-- <tr>
  <td>Name
    <div class="description">
      Description go Here
    </div>
  </td>
  <td>

```javascript
```

  </td>
</tr> -->

</tbody>
</table>
